<!--
 * =====================================================================
 *   This Ant script helps you preparing for building the iSphere
 *   update site. Before you can run the script, you need to copy
 *   'template_ftp.properties' to 'ftp.properties' and change the
 *   properties to meet your needs.
 *
 *   In order to use all features of the script, you need to
 *   have the 'iSphere Ant Plugin' installed.
 *
 *   Here are the steps to create an iSphere update site:
 *
 *     - On the PC run the 'CheckNLSMessages' JUnit test to check
 *       for missing or obsolete message property entries.
 *
 *     - On the PC change version number in COPYRIGHT.RPGLE.
 *     - On the PC push changes of project 'iSphere' to the AS/400.
 *     - On the AS/400 compile and execute command BUILD.
 *     - On the PC update minimum server version number in iSpherePlugin.
 *
 *     - On the PC search java sources for missing copyright header.
 *       Menu: Search -> File -> (?s)\A((?!copyright).)*\Z
 *             Check: Regular expression
 *     - On the PC update document iSphere.doc.
 *     - On the PC print iSphere.doc to 'iSphere for WDSCi 7.0-RDi 8.0+.pdf'.
 *     - On the PC set version number (build.version) in build.properties.
 *       (version number is automatically updated in MANIFEST.MF, feature.xml 
 *        and plugin.xml by build target 'updateVersionNumber'.)
 *
 *   Repeat for RDi and WDSC:
 *     - On the PC run target 'download'.
 *     - On the PC run target 'build' using lauch for RDP or WDSC.
 *     - On the PC right click 'site.xml', 
 *       select 'PDE Tools' -> 'Build Site'.
 *     - On the PC run target 'createSourceForgeFiles'.
 *     - On the PC run target 'uploadSourceForgeFiles'.
 *     - Check files on SourceForge.
 *     - Check the green "Download" button on SourceForge.
 *     - Create SVN tag.
 *   Last step when all changes are committed to the repository and all the
 *   files are published at sourceforge.
 *     - Set the version number in MANIFEST.MF in project "iSphere Notifier"
 *       and commit the change to the repository. After this the iSphere users
 *       get notified of the new iSphere version.
 *
 * ===================================================================== -->
<project basedir="." default="build">

	<!-- Include Ant Contrib tasks -->
	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${basedir}/../lib/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<!-- Load project names and new version number -->
	<property file="build.properties" />

	<!-- Load ftp user name and password -->
	<property file="ftp.properties" />

	<!-- Set date and time -->
	<tstamp>
		<format property="today.timestamp" pattern="dd.MM.yyyy - kk:mm:ss" locale="de,DE"/>
	</tstamp>
	
	<tstamp>
		<format property="today.year" pattern="yyyy" locale="de,DE"/>
	</tstamp>
	
	<!-- Set the iSphere home at SourceForge -->
	<property name="isphere.home" value="https://sourceforge.net/projects/isphere/" />
	
	<!-- Set local FTP download directory -->
	<property name="local.ftp.download.directory" location="${basedir}/temp-downloads" />
	<property name="local.savefile.name" value="ISPHERE" />
	<property name="local.savefile.directory" location="${basedir}/../../${build.project.isphere.core}/Server" />

	<!-- Set regular expressions and replacement values -->
	<property name="validate.version.regex" value="([1-9]+\.[0-9]+(?:\.[0-9]+)?(?:\.(?:b[0-9]{3}|r))?)$" />
	<property name="release.flag.regex" value="^(?:[1-9]+\.[0-9]+(?:\.[0-9]+)?(?:\.(?:b[0-9]{3}|(r)))?)$" />

	<property name="manifest.version.regex" value="(Bundle-Version:\s)([1-9]+\.[0-9]+(?:\.[0-9]+)?(?:\.(?:b[0-9]{1,3}|r))?)" />
	<property name="manifest.version.replace" value="\1${build.version}" />

	<property name="feature.1.version.regex" value="(&lt;feature.*version=&quot;)([1-9]+\.[0-9]+(?:\.[0-9]+)?(?:\.(?:b[0-9]{1,3}|r))?)(&quot;\s+provider-name.*?&gt;)" />
	<property name="feature.1.version.replace" value="\1${build.version}\3" />

	<property name="feature.2.version.regex" value="(&lt;import feature.*version=&quot;)([0-9]+\.[0-9]+(?:\.[0-9]+)?(?:\.(?:b[0-9]{1,3}|r))?)(&quot;\s+match.*?&gt;)" />
	<property name="feature.2.version.replace" value="\1${build.version}\3" />

	<property name="site.1.version.regex" value="(&lt;feature.*_)([0-9]+\.[0-9]+(?:\.[0-9]+)?(?:\.(?:b[0-9]{1,3}|r))?)(\.jar)" />
	<property name="site.1.version.replace" value="\1${build.version}\3" />

	<property name="site.2.version.regex" value="(&lt;feature.*version=&quot;)([0-9]+\.[0-9]+(?:\.[0-9]+)?(?:\.(?:b[0-9]{1,3}|r))?)(&quot;)" />
	<property name="site.2.version.replace" value="\1${build.version}\3" />

	<property name="copyright.1.version.regex" value="^(Version: )([0-9]+\.[0-9]+(?:\.[0-9]+)?(?:\.(?:b[0-9]{1,3}|r))?)(.*)?" />
	<property name="copyright.1.version.replace" value="\1${build.version}\3" />

	<!-- Check for BETA or RELEASE version -->
	<propertyregex property="release.flag" input="${build.version}" regexp="${release.flag.regex}" select="\1" casesensitive="true" />
	<if>
		<equals arg1="${release.flag}" arg2="r" />
		<then>
			<echo>Building a RELEASE version.</echo>
			<property name="sf.ftp.beta.dir" value="." />
		</then>
		<else>
			<echo>Building a BETA version.</echo>
			<property name="sf.ftp.beta.dir" value="${sf.ftp.beta.dir.name}" />
		</else>
	</if>

	<property name="sf.site.target.rdi" value="rdi8.0" />
	<property name="sf.site.target.wdsci" value="wdsci7.0" />
	<property name="sf.ftp.dir.updatesite.web.root" value="/home/project-web/isphere/htdocs/${sf.ftp.beta.dir}/eclipse/" />
	<property name="sf.ftp.dir.updatesite.files.root" value="/home/pfs/project/isphere/${sf.ftp.beta.dir}/" />
	<property name="sf.ftp.dir.updatesite.files.eclipse" value="/home/pfs/project/isphere/${sf.ftp.beta.dir}/eclipse/" />
	<!--
	<property name="sf.ftp.dir.updatesite.web.rdi" value="${sf.ftp.dir.updatesite.web.root}${sf.site.target.rdi}/" />
	<property name="sf.ftp.dir.updatesite.web.wdsc" value="${sf.ftp.dir.updatesite.web.root}${sf.site.target.wdsci}/" />
	<property name="sf.ftp.dir.updatesite.files.rdi" value="${sf.ftp.dir.updatesite.files.root}${sf.site.target.rdi}/" />
	<property name="sf.ftp.dir.updatesite.files.wdsc" value="${sf.ftp.dir.updatesite.files.root}${sf.site.target.wdsci}/" />
	<property name="sf.site.url.rdi" value="http://downloads.sourceforge.net/project/isphere/${sf.ftp.beta.dir}/eclipse/${sf.site.target.rdi}/" />
	<property name="sf.site.url.wdsci" value="http://downloads.sourceforge.net/project/isphere/${sf.ftp.beta.dir}/eclipse/${sf.site.target.wdsci}/" />
	-->

	<!-- iSphere Update Sites -->
	<property name="update.site.url.rdi" value="http://isphere.sourceforge.net/eclipse/${sf.site.target.rdi}/" />
	<property name="update.site.url.wdsci" value="http://isphere.sourceforge.net/eclipse/${sf.site.target.wdsci}/" />

	<!-- IDE Product Name -->
	<property name="ide.product.name.long.rdi" value="IBM Rational Developer for i" />
	<property name="ide.product.name.short.rdi" value="RDi 8.0+" />
	<property name="ide.product.name.long.wdsci" value="Websphere Development Studio Client for iSeries" />
	<property name="ide.product.name.short.wdsci" value="WDSCi 7.0" />

	<!-- Set workspace home directory -->
	<property name="workspace.home" location="${basedir}/../.." />

	<!-- Set zip file and directory names -->
	<property name="build.dir" location="${workspace.home}/${build.project.name}/build" />
	<property name="build.template.dir" location="${build.dir}/templates" />
	<property name="build.template.dir.web" location="${build.template.dir}/template_updatesite_web" />
	<property name="build.template.dir.files" location="${build.template.dir}/template_no_beta_version" />
	<property name="build.upload.dir" location="${workspace.home}/${build.project.name}/upload" />
	<property name="build.upload.dir.files" location="${build.upload.dir}/sf-files" />
	<property name="build.upload.dir.web" location="${build.upload.dir}/sf-web/" />
	<property name="zip.base.directory" location="${workspace.home}/${build.updatesite}" />
	<property name="zip.file.name.rdi" value="iSphere for RDi 8.0+ (v${build.version} Update Site).zip" />
	<property name="zip.file.name.wdsc" value="iSphere for WDSCi 7.0 (v${build.version} Update Site).zip" />
	<property name="isphere.doc" location="${workspace.home}/${build.project.isphere.core}/doc/iSphere.doc" />
	<property name="isphere.pdf" location="${workspace.home}/${build.project.isphere.core}/doc/iSphere for WDSCi 7.0-RDi 8.0+.pdf" />
	<property name="updatesite.tag.file" location="${workspace.home}\${build.updatesite}\${build.updatesite} v${build.version}.tag" />

	<fileset dir="${build.dir}" id="build.changelog.files">
		<include name="Changelog iSphere*.txt" />
	</fileset>

	<!--
    * =====================================================================
    *   Controls the build process:
    *     - update version number
    * ===================================================================== -->
	<target name="build" depends="cleanUpdateSite, updateVersionNumber, createTagFile, refreshProjects" description="build iSphere update site">
		<echo>Finished iSphere build ${build.version}</echo>
		<echo>Open site.xml and press [Build All] to build the iSphere update site.</echo>
		<echo>+------------------------------------------------------+</echo>
		<echo>|  Right-click 'site.xml' and select 'PDE Tools' ->    |</echo>
		<echo>|  'Build Site' to build the update site.              |</echo>
		<echo>|                                                      |</echo>
		<echo>|  Then proceed with:   createSourceForgeFiles         |</echo>
		<echo>|                       uploadSourceForgeFiles         |</echo>
		<echo>+------------------------------------------------------+</echo>
		<echo>*** Finished ***</echo>
	</target>

	<!--
    * =====================================================================
    *   Updates the version numbers of the following files:
    *     - MANIFEST.MF
    *     - feature.xml
    *     - site.xml
    * ===================================================================== -->
	<target name="updateVersionNumber" depends="validateVersionNumber">

		<echo>Updating version number to: ${build.version} ...</echo>

		<for list="${build.projects},${build.updatesite}" delimiter="," param="project">
			<sequential>

				<echo message="${workspace.home}\@{project}" />

				<if>
					<available file="${workspace.home}\@{project}/META-INF" />
					<then>
						<replaceregexp match="${manifest.version.regex}" replace="${manifest.version.replace}" byline="true">
							<fileset dir="${workspace.home}\@{project}/META-INF" includes="MANIFEST.MF" />
						</replaceregexp>
					</then>
				</if>

				<if>
					<available file="${workspace.home}\@{project}/html" />
					<then>
						<replaceregexp match="${copyright.1.version.regex}" replace="${copyright.1.version.replace}" byline="true">
							<fileset dir="${workspace.home}\@{project}/html" includes="copyright.html" />
						</replaceregexp>
					</then>
				</if>

				<replaceregexp match="${feature.1.version.regex}" replace="${feature.1.version.replace}" flags="s" byline="false">
					<fileset dir="${workspace.home}\@{project}" includes="feature.xml" />
				</replaceregexp>

				<replaceregexp match="${feature.2.version.regex}" replace="${feature.2.version.replace}" flags="s" byline="false">
					<fileset dir="${workspace.home}\@{project}" includes="feature.xml" />
				</replaceregexp>

				<replaceregexp match="${site.1.version.regex}" replace="${site.1.version.replace}" flags="g" byline="false">
					<fileset dir="${workspace.home}\@{project}" includes="site.xml" />
				</replaceregexp>

				<replaceregexp match="${site.2.version.regex}" replace="${site.2.version.replace}" flags="g" byline="false">
					<fileset dir="${workspace.home}\@{project}" includes="site.xml" />
				</replaceregexp>

			</sequential>
		</for>

		<echo>Done.</echo>

	</target>

	<target name="validateVersionNumber">

		<echo>Validating version number to: ${build.version} ...</echo>

		<propertyregex property="validated.version" input="${build.version}" regexp="${validate.version.regex}" select="\1" casesensitive="true" />

		<if>
			<equals arg1="${build.version}" arg2="${validated.version}" />
			<then>
				<echo>Version number validated: OK</echo>
			</then>
			<else>
				<echo>+------------------------------------------------------+</echo>
				<echo>| Version number does not match expected pattern!      |</echo>
				<echo>|                                                      |</echo>
				<echo>| Pattern:                                             |</echo>
				<echo>| major.minor.micro.qualifier                          |</echo>
				<echo>|                                                      |</echo>
				<echo>| major - major version number (requested)             |</echo>
				<echo>| minor - minor version number (recommended)           |</echo>
				<echo>| micro - micro version number (optional)              |</echo>
				<echo>|                                                      |</echo>
				<echo>| The possible qualifiers are:                         |</echo>
				<echo>| r     - release version                              |</echo>
				<echo>| bnnn  - beta version, where nnn between 001 and 999  |</echo>
				<echo>+------------------------------------------------------+</echo>
				<fail>*** ERROR: Invalid version number. ***</fail>
			</else>
		</if>

	</target>

	<!--
    * =====================================================================
    *   Creating tag file to indicate the iSphere version
    *   inside the zip file.
    * ===================================================================== -->
	<target name="createTagFile">

		<echo>Creating version tag file ${updatesite.tag.file} ...</echo>

		<touch file="${updatesite.tag.file}" />

	</target>

	<!--
    * =====================================================================
    *   Downloads library ISPHERE from the System i.
    *   This target requires a patched version of commons-net-3.3.jar
    *   where bug NET-512 has been fixed.
    *   (https://issues.apache.org/jira/browse/NET-512)
    * ===================================================================== -->
	<target name="download" depends="ftpCredentialsIBMi">

		<echo>Downloading save file ${IBMi.ftp.savefile.name} ...</echo>

		<ftp action="get" server="${IBMi.ftp.server}" userid="${IBMi.ftp.user}" password="${IBMi.ftp.password}" binary="true" verbose="true" remotedir="${IBMi.ftp.savefile.library}" systemTypeKey="OS/400">
			<fileset dir="${local.ftp.download.directory}" casesensitive="false">
				<include name="${IBMi.ftp.savefile.name}" />
			</fileset>
		</ftp>

		<move file="${local.ftp.download.directory}/${IBMi.ftp.savefile.name}" tofile="${local.savefile.directory}/${local.savefile.name}" overwrite="true" />

		<eclipse.refreshLocal resource="${build.project.name}" depth="infinite" />
		<eclipse.refreshLocal resource="${build.project.isphere.core}" depth="infinite" />

	</target>

	<!--
    * =====================================================================
    *   Asks for FTP credentials: username and password.
    *   Property 'IBMi.ftp.user' is loaded from 'ftp.properties'.
    * ===================================================================== -->
	<target name="ftpCredentialsIBMi" unless="IBMi.ftp.password">

		<input message="Please enter FTP password:" addproperty="IBMi.ftp.password" defaultvalue="" />

	</target>

	<!--
    * =====================================================================
    *   Updates the version numbers of the following files:
    *     - MANIFEST.MF
    *     - feature.xml
    *     - site.xml
    * ===================================================================== -->
	<target name="refreshProjects">

		<echo>Refereshing projects ...</echo>

		<for list="${build.projects},${build.updatesite}" delimiter="," param="project">
			<sequential>
				<eclipse.refreshLocal resource="@{project}" depth="infinite" />
				<echo>* @{project}</echo>
			</sequential>
		</for>

		<echo>Done.</echo>

	</target>

	<!--
    * =====================================================================
    *   Removes all files from the following directories of the 
    *   update site project:
    *     - features
    *     - plugins
    * ===================================================================== -->
	<target name="cleanUpdateSite">

		<echo>Removing old files from '${build.updatesite}' ...</echo>

		<delete includeemptydirs="true">
			<fileset dir="${workspace.home}\${build.updatesite}\features" includes="**/*" />
			<fileset dir="${workspace.home}\${build.updatesite}\plugins" includes="**/*" />
			<fileset dir="${workspace.home}\${build.updatesite}" includes="artifacts.jar" />
			<fileset dir="${workspace.home}\${build.updatesite}" includes="content.jar" />
			<fileset dir="${workspace.home}\${build.updatesite}" includes="*.tag" />
			<fileset dir="${workspace.home}\${build.updatesite}" includes="logs.zip" />
		</delete>

		<eclipse.refreshLocal resource="${build.updatesite}" depth="infinite" />

		<echo>Done.</echo>

	</target>

	<!--
    * =====================================================================
    *   Produces the files that must be uploaded to SourceForge:
    * ===================================================================== -->
	<target name="createSourceForgeFiles" depends="cleanUploadDir,checkPdfFile,updatePdfFile" description="create SourceForge files">

		<echo>Creating files to upload to SourceForge '${build.updatesite}' ...</echo>

		<antcall target="createSourceForgeDownloadAreaFiles" />

		<antcall target="createSourceForgeUpdateSiteWebPage" />

		<echo>+------------------------------------------------------+</echo>
		<echo>|  Check files in 'iSphere Build/upload/...'           |</echo>
		<echo>|                                                      |</echo>
		<echo>|  Then proceed with:   uploadSourceForgeFiles         |</echo>
		<echo>+------------------------------------------------------+</echo>
		<echo>*** Finished ***</echo>

	</target>

	<!--
    * =====================================================================
    *   Removes all files from the 'upload' directory.
    * ===================================================================== -->
	<target name="cleanUploadDir">

		<echo>Cleaning upload directory ...</echo>

		<delete includeemptydirs="true">
			<fileset dir="${workspace.home}\${build.project.name}\upload" includes="**/*" />
		</delete>

		<eclipse.refreshLocal resource="${build.project.name}" depth="infinite" />

	</target>

	<!--
    * =====================================================================
    *   Sets the parameters required for creating the SourceForge files.
    * ===================================================================== -->
	<target name="setSourceForgeParameters">

		<property name="dryrun" value="false"/>
		
		<if>
			<equals arg1="${build.target}" arg2="RDi" />
			<then>
				<property name="sf.site.target" value="${sf.site.target.rdi}" />
				<!--
				<property name="sf.ftp.dir.updatesite.web" value="${sf.ftp.dir.updatesite.web.rdi}" />
				<property name="sf.ftp.dir.updatesite.files" value="${sf.ftp.dir.updatesite.files.rdi}" />
				-->
				<property name="zip.file.name" value="${zip.file.name.rdi}" />
				<property name="exclude.site.xml" value="site.xml" />
				<property name="exclude.web.files" value="**/wdsci*.*" />
				<property name="ide.product.name.long" value="${ide.product.name.long.rdi}"/>
				<property name="ide.product.name.short" value="${ide.product.name.short.rdi}"/>
				<property name="update.site.url" value="${update.site.url.rdi}"/>
			</then>
			<else>
				<property name="sf.site.target" value="${sf.site.target.wdsci}" />
				<!--
				<property name="sf.ftp.dir.updatesite.web" value="${sf.ftp.dir.updatesite.web.wdsc}" />
				<property name="sf.ftp.dir.updatesite.files" value="${sf.ftp.dir.updatesite.files.wdsci}" />
				-->
				<property name="zip.file.name" value="${zip.file.name.wdsc}" />
				<property name="exclude.site.xml" value="" />
				<property name="exclude.web.files" value="**/rdi*.*" />
				<property name="ide.product.name.long" value="${ide.product.name.long.wdsci}"/>
				<property name="ide.product.name.short" value="${ide.product.name.short.wdsci}"/>
				<property name="update.site.url" value="${update.site.url.wdsci}"/>
			</else>
		</if>
		
	</target>
	
	<!--
    * =====================================================================
    *   Create the SourceForge download files.
    * ===================================================================== -->
	<target name="createSourceForgeDownloadAreaFiles" depends="setSourceForgeParameters" >

		<echo>Creating SourceForge download folders ...</echo>
		
		<echo>Preparing directory structure ...</echo>
		<mkdir dir="${build.upload.dir.files}" />
		<mkdir dir="${build.upload.dir.files}/${sf.ftp.beta.dir}/eclipse" />
		<mkdir dir="${build.upload.dir.files}/${sf.ftp.beta.dir}/eclipse/${sf.site.target}" />

		<echo>Copying zip and pdf files ...</echo>
		<zip basedir="${zip.base.directory}" destfile="${build.upload.dir.files}\${sf.ftp.beta.dir}\${zip.file.name}">
			<include name="**/*" />
			<exclude name="**/.project" />
		</zip>
		<copy file="${isphere.pdf}" todir="${build.upload.dir.files}\${sf.ftp.beta.dir}" />

		<echo>Copying Eclipse update site files ...</echo>
		<copy todir="${build.upload.dir.files}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}">
			<fileset dir="${workspace.home}\${build.updatesite}">
				<exclude name="*.log" />
				<exclude name="${exclude.site.xml}" />
				<exclude name=".project" />
			</fileset>
		</copy>

		<echo>Copying release/beta version dependant files ...</echo>
		<if>
			<equals arg1="${sf.ftp.beta.dir}" arg2="." />
			<then>
				<echo>Copying "Not yet available.txt" ...</echo>
				<copy todir="${build.upload.dir.files}/${sf.ftp.beta.dir}">
					<fileset dir="${build.template.dir.files}">
					</fileset>
				</copy>
			</then>
			<else>
				<echo>Copying "Changelog iSphere.txt" ...</echo>
				<copy todir="${build.upload.dir.files}/${sf.ftp.beta.dir}">
					<fileset refid="build.changelog.files">
					</fileset>
				</copy>
			</else>
		</if>

		<eclipse.refreshLocal resource="${build.project.name}" depth="infinite" />
		
	</target>

	<!--
    * =====================================================================
    *   Create the SourceForge Eclipse update site.
    * ===================================================================== -->
	<target name="createSourceForgeUpdateSiteWebPage" depends="setSourceForgeParameters" >

		<echo>Creating Eclipse web folders ...</echo>
		
		<echo>Preparing directory structure ...</echo>
		<mkdir dir="${build.upload.dir.web}" />
		
		<echo>Copying templates directory ...</echo>
		<copy todir="${build.upload.dir.web}/${sf.ftp.beta.dir}">
			<fileset dir="${build.template.dir.web}">
				<exclude name="${exclude.web.files}" />
			</fileset>
		</copy>
		
		<echo>Renaming ${sf.site.target} ...</echo>
		<move todir="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}">
			<fileset dir="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\build_target" />
		</move>

		<echo>Renaming index.html ...</echo>
		<move file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\${build.target}_index.html" 
			tofile="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" />

		<echo>Renaming .htaccess ...</echo>
		<move file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\_htaccess" 
			tofile="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\.htaccess" />

		<echo>Replacing '@' variables ...</echo>
		
		<if>
			<equals arg1="${release.flag}" arg2="r" />
			<then>
				<property name="version.info" value="&lt;div class=&quot;release&quot;&gt;Release Version - ${build.version}&lt;/div&gt;"/>
			</then>
			<else>
			 	<property name="version.info" value="&lt;div class=&quot;beta&quot;&gt;Beta Version - ${build.version}&lt;/div&gt;"/>
			</else>
		</if>
      
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\.htaccess" token="@BUILD_TARGET@" value="${sf.site.target}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\.htaccess" token="@BETA_VERSION@" value="${sf.ftp.beta.dir}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\.htaccess" token="/./" value="/" />

		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" token="@VERSION_INFO@" value="${version.info}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" token="@IDE_PRODUCT_NAME_LONG@" value="${ide.product.name.long}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" token="@IDE_PRODUCT_NAME_SHORT@" value="${ide.product.name.short}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" token="@UPDATE_SITE_URL@" value="${update.site.url}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" token="@TODAY@" value="${today.timestamp}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" token="@YEAR@" value="${today.year}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" token="@VERSION_NUMBER@" value="${build.version}" />
		<replace file="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}\index.html" token="@ISPHERE_HOME@" value="${isphere.home}" />
		
		<eclipse.refreshLocal resource="${build.project.name}" depth="infinite" />
		
	</target>

	<!--
    * =====================================================================
    *   Cleans the SourceForge Eclipse update site.
    * ===================================================================== -->
	<target name="cleanSourceForgeUpdateSite" depends="ftpCredentialsSourceForge,setSourceForgeParameters" >

		<echo>Removing files from the SourceForge Eclipse web folders ...</echo>
		
		<SF user="${sf.ftp.user},${sf.ftp.project}" password="${sf.ftp.password}" trust="true" dryrun="${dryrun}" 
			host="${sf.ftp.server.web}" remoteDir="${sf.ftp.dir.updatesite.web.root}">
			<Rmdir dir="${sf.site.target}" subDirs="true" />
		</SF>
		
	</target>

	<!--
    * =====================================================================
    *   Cleans the SourceForge download files.
    * ===================================================================== -->
	<target name="cleanSourceForgeDownloadFiles" depends="ftpCredentialsSourceForge,setSourceForgeParameters" >

		<echo>Removing files from the SourceForge download directory ...</echo>
		
		<SF user="${sf.ftp.user},${sf.ftp.project}" password="${sf.ftp.password}" trust="true" dryrun="${dryrun}" 
			host="${sf.ftp.server.files}" remoteDir="${sf.ftp.dir.updatesite.files.root}">
			<Rmdir dir="." subDirs="false" />
			<Rmdir dir="./eclipse/${sf.site.target}" subDirs="true" />
		</SF>
		
	</target>
	
	<!--
    * =====================================================================
    *   Update the PDF file from 'iSphere.doc'.
    * ===================================================================== -->
	<target name="updatePdfFile" unless="pdf.isUpToDate">

		<echo>Updating iSphere PDF file ...</echo>

		<winword file="${isphere.doc}" visible="true">
			<saveAs toFile="${isphere.pdf}" saveFormat="pdf" />
		</winword>

		<eclipse.refreshLocal resource="${build.project.isphere.core}" depth="infinite" />

	</target>

	<!--
    * =====================================================================
    *   Check whether the PDF file is up to date.
    * ===================================================================== -->
	<target name="checkPdfFile">
		
		<eclipse.refreshLocal resource="${build.project.isphere.core}" depth="infinite" />
		
		<uptodate property="pdf.isUpToDate" srcfile="${isphere.doc}" targetfile="${isphere.pdf}" />
		
		<echo>Check iSphere PDF result: ${pdf.isUpToDate}</echo>
		
	</target>

	<!--
    * =====================================================================
    *   Uploads the iSphere update site to SourceForge
    * ===================================================================== -->
	<target name="uploadSourceForgeFiles" depends="ftpCredentialsSourceForge,setSourceForgeParameters" description="Uploads the project files to SourceForge">

		<echo>Uploading files to SourceForge ...</echo>

		<echo>Deleting: web folder of the iSphere update site ...</echo>
		<antcall target="cleanSourceForgeUpdateSite" />

		<echo>Uploading: web folder of the iSphere update site ...</echo>
		<antcall target="uploadSourceForgeUpdateSite" />

		<echo>Deleting: download folder of the iSphere update site ...</echo>
		<antcall target="cleanSourceForgeDownloadFiles"></antcall>

		<echo>Uploading: download folder of the iSphere update site ...</echo>
		<antcall target="uploadSourceForgeDownloadFiles" />

	</target>

	<!--
    * =====================================================================
    *   Uploads the iSphere update site web page to SourceForge
    * ===================================================================== -->
	<target name="uploadSourceForgeUpdateSite" depends="ftpCredentialsSourceForge,setSourceForgeParameters" >
		
		<!--
		<scp sftp="true" trust="true" password="${sf.ftp.password}" todir="${sf.ftp.user},${sf.ftp.project}@${sf.ftp.server.web}:${sf.ftp.dir.updatesite.web}">
			<fileset dir="${build.upload.dir.web}\">
			</fileset>
		</scp>
		-->
		
		<SF user="${sf.ftp.user},${sf.ftp.project}" password="${sf.ftp.password}" trust="true" dryrun="${dryrun}" 
			host="${sf.ftp.server.web}" remoteDir="${sf.ftp.dir.updatesite.web.root}">
			<copydir dir="${build.upload.dir.web}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}" toDir="${sf.site.target}" subDirs="true" />
		</SF>
		
	</target>

	<!--
    * =====================================================================
    *   Uploads the files of the iSphere update site to 
    *   the SourceForge download area.
    * ===================================================================== -->
	<target name="uploadSourceForgeDownloadFiles" depends="ftpCredentialsSourceForge,setSourceForgeParameters" >
		
		<!--
		<scp sftp="true" trust="true" password="${sf.ftp.password}" todir="${sf.ftp.user},${sf.ftp.project}@${sf.ftp.server.files}:${sf.ftp.dir.updatesite.files}">
			<fileset dir="${build.upload.dir.files}\">
			</fileset>
		</scp>
		-->
		
		<SF user="${sf.ftp.user},${sf.ftp.project}" password="${sf.ftp.password}" trust="true" dryrun="${dryrun}" 
			host="${sf.ftp.server.files}" remoteDir="${sf.ftp.dir.updatesite.files.root}">
			<copydir dir="${build.upload.dir.files}\${sf.ftp.beta.dir}" toDir="." subDirs="false" />
			<copydir dir="${build.upload.dir.files}\${sf.ftp.beta.dir}\eclipse\${sf.site.target}" toDir="./eclipse/${sf.site.target}" subDirs="true" />
		</SF>
		
	</target>

	<!--
    * =====================================================================
    *   Asks for FTP credentials: username and password.
    *   Properties 'sf.ftp.user' is loaded from 'ftp.properties'.
    * ===================================================================== -->
	<target name="ftpCredentialsSourceForge" unless="sf.ftp.password">

		<input message="Please enter the SourceForge FTP password:" addproperty="sf.ftp.password" defaultvalue="" />

	</target>

	<!--
    * =====================================================================
    *   Nice to have but does not yet work.
    * ===================================================================== -->
	<target name="buildScript">

		<eclipse.buildScript elements="feature@biz.isphere.core" buildDirectory="C:/workspaces/rdp_070/workspace/iSphere Build/build/temp" outputUpdateJars="true" />

	</target>

</project>